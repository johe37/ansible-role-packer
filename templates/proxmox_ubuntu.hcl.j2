# Packer file
# ---

packer {
    required_plugins {
        qemu = {
            version = ">= 1.0.3"
            source = "github.com/hashicorp/qemu"
        }
        ansible = {
            version = ">= 1.0.0"
            source = "github.com/hashicorp/ansible"
        }
    }
}

# Resource definition for the Proxmox VM Template
source "proxmox" "proxmox" {
    proxmox_url = "{{ packer_proxmox_api_url }}"
    username = "{{ packer_proxmox_api_user }}"
    password = "{{ packer_proxmox_api_password }}"
    # (Optional) Skip TLS Verification
    insecure_skip_tls_verify = true
    
    node = "pve1"
    vm_name = "packer-ubuntu-22-04-2-template"
    template_description = "Ubuntu 22.04.2 template image"

    # VM OS Settings
    # (Option 1) Local ISO File
    iso_file = "local:iso/ubuntu-22.04.2-live-server-amd64.iso"
    # - or -
    # (Option 2) Download ISO
    #iso_url = "http://releases.ubuntu.com/22.10/ubuntu-22.10-live-server-amd64.iso"
    #iso_checksum = "874452797430a94ca240c95d8503035aa145bd03ef7d84f9b23b78f3c5099aed"

    iso_storage_pool = "local"
    unmount_iso = true

    cores = "1"
    memory = "2048"
    qemu_agent = true
    scsi_controller = "virtio-scsi-pci"
    disks {
        disk_size = "20G"
        format = "qcow2"
        storage_pool = "local"
        storage_pool_type = "lvm"
        type = "virtio"
    }
    network_adapters {
        model = "virtio"
        bridge = "vmbr0"
        firewall = "false"
    } 

    # VM Cloud-Init Settings
    cloud_init = true
    cloud_init_storage_pool = "local"

    boot_command = [
        "<esc><wait>",
        "e<wait>",
        "<down><down><down><end>",
        "<bs><bs><bs><bs><wait>",
        "autoinstall ds=nocloud-net\\;s=http://{{ '{{' }} .HTTPIP {{ '}}' }}:{{ '{{' }}.HTTPPort {{ '}}' }}/ ---<wait>",
        "<f10><wait>"
    ]
    boot = "c"
    boot_wait = "5s"
    http_directory = "http" 

    ssh_username = "packer"
    #ssh_password = "changeme"
    ssh_private_key_file = "{{ lookup('env', 'HOME') }}/.ssh/home" 
    ssh_timeout = "30m"
}

# Build Definition to create the VM Template
build {

    sources = ["source.proxmox.proxmox"]

    # Provisioning the VM Template for Cloud-Init Integration in Proxmox
    provisioner "file" {
        source = "files/99-pve.cfg"
        destination = "/tmp/99-pve.cfg"
    }

    # Provisioning the VM Template for Cloud-Init Integration in Proxmox
    provisioner "shell" {
        inline = [
            "sudo cp /tmp/99-pve.cfg /etc/cloud/cloud.cfg.d/99-pve.cfg",
            "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
        ]
    }

    provisioner "ansible" {
        playbook_file = "files/provision-image.yml"
        ansible_env_vars = [
            "ANSIBLE_SSH_ARGS='-o ControlMaster=no -o ControlPersist=180s -o ServerAliveInterval=120s -o TCPKeepAlive=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -o HostkeyAlgorithms=+ssh-rsa'",
            "ANSIBLE_PIPELINING=True",
            "ANSIBLE_REMOTE_TEMP=/tmp",
        ]
    }

    provisioner "shell" {
        inline = [
            "sudo su root -c \"userdel -rf packer; rm /etc/sudoers.d/90-cloud-init-users; /sbin/shutdown -hP now\""
        ]
    }
}

# Packer file
# ---

packer {
    required_plugins {
        qemu = {
            version = ">= 1.0.3"
            source = "github.com/hashicorp/qemu"
        }
        ansible = {
            version = ">= 1.0.0"
            source = "github.com/hashicorp/ansible"
        }
    }
}

# Resource definition for the Proxmox VM Template
source "proxmox" "proxmox" {
    proxmox_url = "{{ packer_proxmox_api_url }}"
    username = "{{ packer_proxmox_api_user }}"
    password = "{{ packer_proxmox_api_password }}"
    insecure_skip_tls_verify = true
    
    node = "pve2"
    vm_name = "packer-almalinux-9-1-template"
    template_description = "AlmaLinux 9.1 template image"

    # VM OS Settings
    # (Option 1) Local ISO File
    iso_file = "local:iso/AlmaLinux-9.1-x86_64-boot.iso"
    # - or -
    # (Option 2) Download ISO
    #iso_url = "http://releases.ubuntu.com/22.10/ubuntu-22.10-live-server-amd64.iso"
    #iso_checksum = "874452797430a94ca240c95d8503035aa145bd03ef7d84f9b23b78f3c5099aed"

    iso_storage_pool = "local"
    unmount_iso = true

    cpu_type = "host"
    cores = "1"
    memory = "2048"
    qemu_agent = true
    scsi_controller = "virtio-scsi-pci"
    disks {
        disk_size = "20G"
        format = "qcow2"
        storage_pool = "local"
        storage_pool_type = "lvm"
        type = "virtio"
    }
    network_adapters {
        model = "virtio"
        bridge = "vmbr0"
        firewall = "false"
    } 

    cloud_init = true
    cloud_init_storage_pool = "local"

    # PACKER Boot Commands
    boot_command = [
        "<tab> inst.text net.ifnames=0 inst.gpt inst.ks=http://{{ '{{' }} .HTTPIP {{ '}}' }}:{{ '{{' }} .HTTPPort {{' }}' }}/target.ks<enter><wait>"
    ]
    boot = "c"
    boot_wait = "10s"
    http_directory = "http"

    ssh_timeout = "30m"
    ssh_username = "root"
    # (Option 1) Add your Password here
    ssh_password = "changeme"
    # - or -
    # (Option 2) Add your Private SSH KEY file here
    #ssh_private_key_file = ""
}

# Build Definition to create the VM Template
build {

    sources = ["source.proxmox.proxmox"]

    provisioner "ansible" {
        playbook_file = "files/provision-image.yml"
        ansible_env_vars = [
            "ANSIBLE_SSH_ARGS='-o ControlMaster=no -o ControlPersist=180s -o ServerAliveInterval=120s -o TCPKeepAlive=yes -o PubkeyAcceptedKeyTypes=+ssh-rsa -o HostkeyAlgorithms=+ssh-rsa'",
            "ANSIBLE_PIPELINING=True",
            "ANSIBLE_REMOTE_TEMP=/tmp",
        ]
    }
}

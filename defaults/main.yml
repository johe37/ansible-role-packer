---
packer_working_dir: "{{ lookup('env', 'PWD') }}/tmp/packer"
packer_template_content: ~
packer_config_files:
  - path: "{{ packer_working_dir }}/packer.pkr.hcl"
    content: "{{ packer_template_content | default('Set the packer_template_content variable to specify which template to use.') }}"
  - path: "{{ packer_working_dir }}/files/99-pve.cfg" # For proxmox
    content: "datasource_list: [ConfigDrive, NoCloud]"
  - path: "{{ packer_working_dir }}/http/meta-data"
    content: ""
  - path: "{{ packer_working_dir }}/http/user-data"
    content: "{{ lookup('template', lookup('env', 'PWD') + '/ansible/roles/packer/templates/user-data.j2') }}"
  - path: "{{ packer_working_dir }}/http/target.ks"
    content: "{{ packer_ks }}"
  - path: "{{ packer_working_dir }}/files/provision-image.yml"
    content: "{{ lookup('file', lookup('env', 'PWD') + '/ansible/roles/packer/files/playbooks/provision-image.yml') }}"
packer_ks: |
  url --url="https://repo.almalinux.org/almalinux/9.1/BaseOS/x86_64/kickstart/"
  text
  firstboot --disabled
  bootloader --append="nofb ipv6.disable=1 selinux=0 noselinux geoloc=0 consoleblank=0 audit=0 inst.sshd" --location=mbr

  lang en_US.UTF-8
  keyboard se
  timezone UTC --utc
  network --bootproto=dhcp --device=link

  # Clear the Master Boot Record
  zerombr
  # Remove partitions
  clearpart --all --initlabel
  # Automatically create partitions using LVM
  autopart --type=lvm

  rootpw --plaintext changeme

  reboot --eject

  %packages
  @core
  -biosdevname
  -open-vm-tools
  -plymouth
  -dnf-plugin-spacewalk
  -rhn*
  -iprutils
  -iwl*-firmware
  openssh-server
  %end


  # disable kdump service
  %addon com_redhat_kdump --disable
  %end


  %post
  sed -i "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/g" /etc/ssh/sshd_config

  # Enable NetworkManager, sshd and disable firewalld
  #/usr/bin/systemctl enable NetworkManager
  /usr/bin/systemctl enable sshd
  /usr/bin/systemctl start sshd
  #/usr/bin/systemctl disable firewalld

  # Need for host/guest communication
  /usr/bin/systemctl enable qemu-guest-agent
  /usr/bin/systemctl start qemu-guest-agent

  %end

################################### PACKER PROXMOX ####################################
#
packer_proxmox_api_url: ~
packer_proxmox_api_user: ~
packer_proxmox_api_password: ~
...